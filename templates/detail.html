{% extends "base.html" %}

{% block title %}{{ item[item.keys()|list|first] }} - Detail{% endblock %}

{% block content %}
<div class="content-header">
    <div class="breadcrumb">
        <a href="{{ url_for('index') }}">Home</a> 
        <span>/</span> 
        <a href="{{ url_for('category_list', csv_path=csv_path) }}">{{ category }}</a>
        <span>/</span> 
        <span class="current">{{ item[item.keys()|list|first] }}</span>
    </div>
</div>

<div class="detail-container">
    <div class="detail-header">
        <h1>{{ item[item.keys()|list|first] }}</h1>
        {% if '显示名字' in item and item['显示名字'] %}
        <p class="romanization">{{ item['显示名字'] }}</p>
        {% endif %}
    </div>

    <div class="detail-content">
        <div class="detail-image-section">
            {% if image_path %}
            <img src="/images/{{ image_path }}" 
                 alt="{{ item[item.keys()|list|first] }}"
                 class="detail-image"
                 onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'no-image-large\'>No Image Available</div>'">
            {% else %}
            <div class="no-image-large">No Image Available</div>
            {% endif %}
        </div>

        <div class="detail-info-section">
            <!-- Chapter and Original Text Section -->
            {% if chapter or original_text %}
            <div class="info-block chapter-section">
                <h2>Classical Text</h2>
                {% if chapter %}
                <div class="chapter-info">
                    <span class="label-inline">Chapter:</span>
                    <span class="chapter-name">《{{ chapter }}》</span>
                </div>
                {% endif %}
                {% if original_text %}
                <div class="original-text">
                    <p>{{ original_text }}</p>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- All Occurrences -->
            {% if all_occurrences and all_occurrences|length > 1 %}
            <div class="info-block occurrences-section">
                <h3>All Occurrences ({{ all_occurrences|length }})</h3>
                <div class="occurrences-list">
                    {% for occurrence in all_occurrences %}
                    <div class="occurrence-item">
                        <div class="occurrence-chapter">《{{ occurrence.chapter }}》</div>
                        <div class="occurrence-text">{{ occurrence.original_text }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <h2>Information</h2>
            
            {% if 'prompt翻译' in item and item['prompt翻译'] %}
            <div class="info-block">
                <h3>Description (English)</h3>
                <p class="description">{{ item['prompt翻译'] }}</p>
            </div>
            {% endif %}
            
            {% if 'prompt' in item and item['prompt'] %}
            <div class="info-block">
                <h3>Original Prompt (Chinese)</h3>
                <p class="description-chinese">{{ item['prompt'] }}</p>
            </div>
            {% endif %}
            
            <div class="info-block">
                <h3>Details</h3>
                <table class="detail-table">
                    {% for key, value in item.items() %}
                        {% if key not in ['prompt', 'prompt翻译', 'image_path', '显示名字'] and value %}
                        <tr>
                            <td class="label">{{ key }}</td>
                            <td class="value">{{ value }}</td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </table>
            </div>
            
            <div class="action-buttons">
                <a href="{{ url_for('category_list', csv_path=csv_path) }}" class="btn btn-secondary">
                    &laquo; Back to List
                </a>
            </div>
        </div>
    </div>

    <!-- Network Graph Section -->
    {% if network_html %}
    <div class="network-section">
        <h2>Knowledge Network</h2>
        <p class="network-description">Interactive visualization showing relationships between this entity and related elements from the Classic of Mountains and Seas.</p>
        <div class="network-container">
            {{ network_html|safe }}
        </div>
    </div>
    {% endif %}

    <!-- Location Map Section -->
    <div class="map-section" style="margin-top: 40px;">
        <h2>Geographic Distribution</h2>
        {% if location_data and location_data.has_location %}
        <p class="map-description">This entity appears in the following regions according to the Classic of Mountains and Seas:</p>
        <div class="location-info">
            <h3>Chapters:</h3>
            <ul class="chapter-list">
                {% for chapter in location_data.chapters %}
                <li>
                    <strong>{{ chapter.name }}</strong> - 
                    <span class="province-list">{{ chapter.provinces|join(', ') }}</span>
                </li>
                {% endfor %}
            </ul>
        </div>
        <div id="entityMap" style="width: 100%; height: 500px; margin-top: 20px;"></div>
        {% else %}
        <p class="no-location">{{ location_data.message if location_data else '可能来源于神话章节' }}</p>
        {% endif %}
    </div>
</div>

{% if location_data and location_data.has_location %}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Province name mapping - add 省/自治区 suffix
    const provinceNameMap = {
        '浙江': '浙江省',
        '江西': '江西省',
        '湖南': '湖南省',
        '广东': '广东省',
        '广西': '广西壮族自治区',
        '四川': '四川省',
        '贵州': '贵州省',
        '云南': '云南省',
        '陕西': '陕西省',
        '甘肃': '甘肃省',
        '青海': '青海省',
        '宁夏': '宁夏回族自治区',
        '新疆': '新疆维吾尔自治区',
        '西藏': '西藏自治区',
        '内蒙古': '内蒙古自治区',
        '山西': '山西省',
        '河北': '河北省',
        '河南': '河南省',
        '山东': '山东省',
        '安徽': '安徽省',
        '江苏': '江苏省',
        '湖北': '湖北省',
        '福建': '福建省',
        '海南': '海南省',
        '辽宁': '辽宁省',
        '吉林': '吉林省',
        '黑龙江': '黑龙江省'
    };

    // Fetch China map data and render
    fetch('https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json')
        .then(response => response.json())
        .then(geoJson => {
            const chart = echarts.init(document.getElementById('entityMap'));
            
            // Register map
            echarts.registerMap('china', geoJson);
            
            // Prepare data from location_data
            const locationData = {{ location_data|tojson }};
            
            // Map provinces with full names and prepare tooltip data
            const provinceData = [];
            const provincesInfo = {};
            
            for (const [province, chapters] of Object.entries(locationData.provinces)) {
                const fullProvinceName = provinceNameMap[province] || province;
                provinceData.push({
                    name: fullProvinceName,
                    value: chapters.length,
                    chapters: chapters
                });
                provincesInfo[fullProvinceName] = chapters;
            }
            
            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        if (params.data && params.data.chapters) {
                            return params.name + '<br/>' + 
                                   '章节: ' + params.data.chapters.join(', ') + '<br/>' +
                                   '出现次数: ' + params.data.value;
                        }
                        return params.name;
                    }
                },
                visualMap: {
                    min: 0,
                    max: Math.max(...provinceData.map(d => d.value)),
                    text: ['多', '少'],
                    realtime: false,
                    calculable: true,
                    inRange: {
                        color: ['#e0f3f8', '#abd9e9', '#74add1', '#4575b4', '#313695']
                    },
                    left: 'left',
                    bottom: '20px'
                },
                series: [
                    {
                        name: '出现区域',
                        type: 'map',
                        map: 'china',
                        roam: true,
                        emphasis: {
                            label: {
                                show: true
                            },
                            itemStyle: {
                                areaColor: '#ffd700'
                            }
                        },
                        data: provinceData
                    }
                ]
            };
            
            chart.setOption(option);
            
            // Responsive resize
            window.addEventListener('resize', () => chart.resize());
        })
        .catch(error => {
            console.error('Error loading map:', error);
            document.getElementById('entityMap').innerHTML = '<div style="text-align:center;padding:50px;color:#666;">地图加载失败</div>';
        });
});
</script>
{% endif %}

{% endblock %}
