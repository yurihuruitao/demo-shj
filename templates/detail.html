{% extends "base.html" %}

{% block title %}{{ item[item.keys()|list|first] }} - Detail{% endblock %}

{% block content %}
<div class="content-header">
    <div class="breadcrumb">
        <a href="{{ url_for('index') }}">Home</a> 
        <span>/</span> 
        <a href="{{ url_for('category_list', csv_path=csv_path) }}">{{ category }}</a>
        <span>/</span> 
        <span class="current">{{ item[item.keys()|list|first] }}</span>
    </div>
</div>

<div class="detail-container">
    <div class="detail-header">
        <h1>{{ item[item.keys()|list|first] }}</h1>
        {% if 'ÊòæÁ§∫ÂêçÂ≠ó' in item and item['ÊòæÁ§∫ÂêçÂ≠ó'] %}
        <p class="romanization">{{ item['ÊòæÁ§∫ÂêçÂ≠ó'] }}</p>
        {% endif %}
    </div>

    <div class="detail-content">
        <div class="detail-image-section">
            {% if image_path %}
            <img src="/images/{{ image_path }}" 
                 alt="{{ item[item.keys()|list|first] }}"
                 class="detail-image"
                 onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'no-image-large\'>No Image Available</div>'">
            {% else %}
            <div class="no-image-large">No Image Available</div>
            {% endif %}
        </div>

        <div class="detail-info-section">
            <!-- Chapter and Original Text Section -->
            {% if chapter or original_text %}
            <div class="info-block chapter-section">
                <h2>Classical Text</h2>
                {% if chapter %}
                <div class="chapter-info">
                    <span class="label-inline">Chapter:</span>
                    <span class="chapter-name">„Ää{{ chapter }}„Äã</span>
                </div>
                {% endif %}
                {% if original_text %}
                <div class="original-text">
                    <p>{{ original_text }}</p>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- All Occurrences -->
            {% if all_occurrences and all_occurrences|length > 1 %}
            <div class="info-block occurrences-section">
                <h3>All Occurrences ({{ all_occurrences|length }})</h3>
                <div class="occurrences-list">
                    {% for occurrence in all_occurrences %}
                    <div class="occurrence-item">
                        <div class="occurrence-chapter">„Ää{{ occurrence.chapter }}„Äã</div>
                        <div class="occurrence-text">{{ occurrence.original_text }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <h2>Information</h2>
            
            {% if 'promptÁøªËØë' in item and item['promptÁøªËØë'] %}
            <div class="info-block">
                <h3>Description (English)</h3>
                <p class="description">{{ item['promptÁøªËØë'] }}</p>
            </div>
            {% endif %}
            
            {% if 'prompt' in item and item['prompt'] %}
            <div class="info-block">
                <h3>Original Prompt (Chinese)</h3>
                <p class="description-chinese">{{ item['prompt'] }}</p>
            </div>
            {% endif %}
            
            <div class="info-block">
                <h3>Details</h3>
                <table class="detail-table">
                    {% for key, value in item.items() %}
                        {% if key not in ['prompt', 'promptÁøªËØë', 'image_path', 'ÊòæÁ§∫ÂêçÂ≠ó'] and value %}
                        <tr>
                            <td class="label">{{ key }}</td>
                            <td class="value">{{ value }}</td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </table>
            </div>
            
            <div class="action-buttons">
                <a href="{{ url_for('category_list', csv_path=csv_path) }}" class="btn btn-secondary">
                    &laquo; Back to List
                </a>
            </div>
        </div>
    </div>

    <!-- Network Graph Section -->
    {% if network_html %}
    <div class="network-section">
        <h2>Knowledge Network</h2>
        <p class="network-description">Interactive visualization showing relationships between this entity and related elements from the Classic of Mountains and Seas.</p>
        <div class="network-container">
            {{ network_html|safe }}
        </div>
    </div>
    {% endif %}

    <!-- Location Map Section -->
    <div class="map-section" style="margin-top: 40px;">
        <h2>Geographic Distribution</h2>
        {% if location_data and location_data.has_location %}
        <p class="map-description">This entity appears in the following regions according to the Classic of Mountains and Seas:</p>
        <div class="location-info">
            <h3>Chapters:</h3>
            <ul class="chapter-list">
                {% for chapter in location_data.chapters %}
                <li>
                    <strong>{{ chapter.name }}</strong> - 
                    <span class="province-list">{{ chapter.provinces|join(', ') }}</span>
                </li>
                {% endfor %}
            </ul>
        </div>
        <div id="entityMap" style="width: 100%; height: 500px; margin-top: 20px;"></div>
        {% else %}
        <p class="no-location">{{ location_data.message if location_data else 'ÂèØËÉΩÊù•Ê∫ê‰∫éÁ•ûËØùÁ´†ËäÇ' }}</p>
        {% endif %}
    </div>
</div>

{% if location_data and location_data.has_location %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load ECharts with multiple fallback CDNs (optimized for Asia-Pacific)
    const echartsUrls = [
        'https://unpkg.com/echarts@5.4.3/dist/echarts.min.js',
        'https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js',
        'https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js',
        'https://fastly.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js',
        'https://lib.baomitu.com/echarts/5.4.3/echarts.min.js'
    ];
    
    let echartsLoaded = false;
    let currentUrlIndex = 0;
    
    function loadECharts() {
        if (currentUrlIndex >= echartsUrls.length) {
            console.error('Failed to load ECharts from all CDN sources');
            document.getElementById('entityMap').innerHTML = 
                '<div style="text-align:center;padding:50px;color:#e74c3c;"><strong>‚ö†Ô∏è Unable to load map data from all sources.</strong><br>Please check your internet connection and refresh the page.</div>';
            return;
        }
        
        const script = document.createElement('script');
        script.src = echartsUrls[currentUrlIndex];
        script.onload = function() {
            console.log('‚úÖ ECharts loaded from:', echartsUrls[currentUrlIndex]);
            echartsLoaded = true;
            initMap();
        };
        script.onerror = function() {
            console.warn('‚ùå Failed to load from:', echartsUrls[currentUrlIndex]);
            currentUrlIndex++;
            loadECharts();
        };
        document.head.appendChild(script);
    }
    
    function initMap() {
        if (!window.echarts) {
            console.error('ECharts is not available');
            return;
        }
        
        // Province name mapping - add ÁúÅ/Ëá™Ê≤ªÂå∫ suffix
        const provinceNameMap = {
        'ÊµôÊ±ü': 'ÊµôÊ±üÁúÅ',
        'Ê±üË•ø': 'Ê±üË•øÁúÅ',
        'ÊπñÂçó': 'ÊπñÂçóÁúÅ',
        'Âπø‰∏ú': 'Âπø‰∏úÁúÅ',
        'ÂπøË•ø': 'ÂπøË•øÂ£ÆÊóèËá™Ê≤ªÂå∫',
        'ÂõõÂ∑ù': 'ÂõõÂ∑ùÁúÅ',
        'Ë¥µÂ∑û': 'Ë¥µÂ∑ûÁúÅ',
        '‰∫ëÂçó': '‰∫ëÂçóÁúÅ',
        'ÈôïË•ø': 'ÈôïË•øÁúÅ',
        'ÁîòËÇÉ': 'ÁîòËÇÉÁúÅ',
        'ÈùíÊµ∑': 'ÈùíÊµ∑ÁúÅ',
        'ÂÆÅÂ§è': 'ÂÆÅÂ§èÂõûÊóèËá™Ê≤ªÂå∫',
        'Êñ∞ÁñÜ': 'Êñ∞ÁñÜÁª¥ÂêæÂ∞îËá™Ê≤ªÂå∫',
        'Ë•øËóè': 'Ë•øËóèËá™Ê≤ªÂå∫',
        'ÂÜÖËíôÂè§': 'ÂÜÖËíôÂè§Ëá™Ê≤ªÂå∫',
        'Â±±Ë•ø': 'Â±±Ë•øÁúÅ',
        'Ê≤≥Âåó': 'Ê≤≥ÂåóÁúÅ',
        'Ê≤≥Âçó': 'Ê≤≥ÂçóÁúÅ',
        'Â±±‰∏ú': 'Â±±‰∏úÁúÅ',
        'ÂÆâÂæΩ': 'ÂÆâÂæΩÁúÅ',
        'Ê±üËãè': 'Ê±üËãèÁúÅ',
        'ÊπñÂåó': 'ÊπñÂåóÁúÅ',
        'Á¶èÂª∫': 'Á¶èÂª∫ÁúÅ',
        'Êµ∑Âçó': 'Êµ∑ÂçóÁúÅ',
        'ËæΩÂÆÅ': 'ËæΩÂÆÅÁúÅ',
        'ÂêâÊûó': 'ÂêâÊûóÁúÅ',
        'ÈªëÈæôÊ±ü': 'ÈªëÈæôÊ±üÁúÅ'
    };

    // Fetch China map data and render - try multiple sources
    const mapSources = [
        'https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json',
        'https://unpkg.com/echarts@5.4.3/map/json/china.json',
        'https://cdn.jsdelivr.net/npm/echarts@5.4.3/map/json/china.json',
        'https://fastly.jsdelivr.net/npm/echarts@5.4.3/map/json/china.json'
    ];
    
    let mapSourceIndex = 0;
    
    function loadMapData() {
        if (mapSourceIndex >= mapSources.length) {
            console.error('Failed to load map from all sources');
            document.getElementById('entityMap').innerHTML = 
                '<div style="text-align:center;padding:50px;color:#e74c3c;">‚ö†Ô∏è Âú∞ÂõæÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•,ËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•</div>';
            return;
        }
        
        console.log('üîÑ Trying to load map from:', mapSources[mapSourceIndex]);
        
        // Add timeout to prevent hanging
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout
        
        fetch(mapSources[mapSourceIndex], { signal: controller.signal })
        .then(response => {
            clearTimeout(timeoutId);
            if (!response.ok) {
                throw new Error('HTTP error ' + response.status);
            }
            return response.json();
        })
        .then(geoJson => {
            console.log('‚úÖ Map data loaded from:', mapSources[mapSourceIndex]);
            const chart = echarts.init(document.getElementById('entityMap'));
            
            // Register map
            echarts.registerMap('china', geoJson);
            
            // Prepare data from location_data
            const locationData = {{ location_data|tojson }};
            
            // Map provinces with full names and prepare tooltip data
            const provinceData = [];
            const provincesInfo = {};
            
            for (const [province, chapters] of Object.entries(locationData.provinces)) {
                const fullProvinceName = provinceNameMap[province] || province;
                provinceData.push({
                    name: fullProvinceName,
                    value: chapters.length,
                    chapters: chapters
                });
                provincesInfo[fullProvinceName] = chapters;
            }
            
            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        if (params.data && params.data.chapters) {
                            return params.name + '<br/>' + 
                                   'Á´†ËäÇ: ' + params.data.chapters.join(', ') + '<br/>' +
                                   'Âá∫Áé∞Ê¨°Êï∞: ' + params.data.value;
                        }
                        return params.name;
                    }
                },
                visualMap: {
                    min: 0,
                    max: Math.max(...provinceData.map(d => d.value)),
                    text: ['Â§ö', 'Â∞ë'],
                    realtime: false,
                    calculable: true,
                    inRange: {
                        color: ['#e0f3f8', '#abd9e9', '#74add1', '#4575b4', '#313695']
                    },
                    left: 'left',
                    bottom: '20px'
                },
                series: [
                    {
                        name: 'Âá∫Áé∞Âå∫Âüü',
                        type: 'map',
                        map: 'china',
                        roam: true,
                        emphasis: {
                            label: {
                                show: true
                            },
                            itemStyle: {
                                areaColor: '#ffd700'
                            }
                        },
                        data: provinceData
                    }
                ]
            };
            
            chart.setOption(option);
            
            // Responsive resize
            window.addEventListener('resize', () => chart.resize());
        })
        .catch(error => {
            console.error('‚ùå Error loading map from:', mapSources[mapSourceIndex], error);
            mapSourceIndex++;
            loadMapData();
        });
    }
    
    // Start loading map data
    loadMapData();
    }
    
    // Start loading ECharts
    loadECharts();
});
</script>
{% endif %}

{% endblock %}
